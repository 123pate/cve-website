<template>
  <div class="horizontal-bar-chart">
  </div><!-- .horizontal-bar-chart -->
</template>

<script>
import * as d3 from 'd3';
export default {
  name: 'HorizontalBarChart',
  props:[ 
    	'visualizationData'
  ],
  data: function() {
  	return {
  		shortLabels: {
  			'Information Exposure Through an Error Message': 'Info Exposure Via Error Message'
  		}
  	}
  },
  methods: {
    
  },
  mounted: function() {
  	window.d3 = d3;
  	var self = this;
  	var barHeight = 18;
  	var barMargin = 2;
  	var barTotal = barHeight + barMargin;
  	var orderMargin = 30;
  	var labelMargin = 280;
  	var valueMargin = 50;
  	var barMargin = 20;
    var data = this.visualizationData.slice().sort((a, b) => d3.descending(a.Total, b.Total));
  	var w = 800;
    var h = data.length * barTotal;
    var margin = {top: 10, left: 0, right: 30, bottom: 10};
    var svg = d3.select(this.$el).append("svg")
      .attr("width", w)
      .attr("height", h + margin.top + margin.bottom);

    for(var i=0; i<data.length; i++) {
    	console.log(data[i]);
    }

    var xScale = d3.scaleLinear()
			.rangeRound([0,w-margin.left-margin.right - orderMargin - labelMargin - valueMargin - barMargin])
			.domain([0, d3.max(data, function(d) {
				return d.Total;
			})]);
 
    // svg.append('g')
    //    .attr('class','axis')
    //    .attr('transform', 'translate(' + margin.left+', '+margin.top+')')
    //    .call(yAxis);

    var bars = svg.append('g')
      .attr('transform', 'translate('+margin.left+', ' + margin.top+')')
      .classed('bars', true);

    var barGroups = bars.selectAll('.bar-group')
    	.data(data);

    var barGroupsEnter = barGroups
     .enter()
     .append('g')
     		.attr('class', 'bar-group')
     		.attr('transform', function(d, i) {
     			return 'translate(0,' + (i * barTotal) + ')';
     		});

	barGroupsEnter
   	.append('rect')
   	.attr('class', 'bar-click')
    .attr('width', w - margin.left - margin.right)
    .attr('height', barHeight);

	barGroupsEnter
   	.append('text')
   	.attr('dy', '4px')
   	.attr('class', 'order-text')
   	.attr('alignment-baseline', 'hanging')
   	.text(function(d, i) {
   		return i+1;
   	});

	barGroupsEnter
   	.append('text')
   	.attr('dy', '4px')
   	.attr('class', 'label-text')
   	.attr('alignment-baseline', 'hanging')
   	.attr('transform', 'translate(' + orderMargin + ', 0)')
   	.text(function(d, i) {
   		let wn = d.WeaknessName;
   		if(self.shortLabels[d.WeaknessName] !== undefined) {
   			wn = self.shortLabels[d.WeaknessName];
   		}
   		return wn;
   	});

	barGroupsEnter
   	.append('text')
   	.attr('dy', '4px')
   	.attr('class', 'value-text')
   	.attr('text-anchor', 'end')
   	.attr('alignment-baseline', 'hanging')
   	.attr('transform', 'translate(' + (orderMargin + labelMargin + valueMargin) + ', 0)')
   	.text(function(d, i) {
   		return d3.format(',')(d.Total);
   	});

	barGroupsEnter
   	.append('rect')
   	.attr('class', 'bar-rect')
    .attr('width', function(d,i) {
      return Math.max(1, xScale(d.Total));
    })
    .attr('x', function(d,i) {
    	return orderMargin + labelMargin + valueMargin + barMargin;
    })
    .attr('height', barHeight)
    .attr("fill","#000");
	
  }
};
</script>

<style lang="scss">
	svg text {
		font-family: 'Roboto';
		font-size: 13px;
		text-transform: uppercase;
	}

	.bar-click {
		cursor: pointer;
		fill: transparent;
	}

	.bar-click:hover {
		fill: #eee;
	}

	.order-text,
	.label-text,
	.value-text,
	.bar-rect {
		pointer-events: none;
	}
</style>
