<template>
  <div class="field has-addons is-grouped-right">
    <div class="control is-expanded has-icons-right">
        <input v-model="cveId" @keyup.enter="saveId" class="input cve-lookup-input" type="text" placeholder="Enter CVE ID (e.g.: CVE-YYYY-NNNN...)" 
        style="width: 400px">
        <button class="button cve-button cve-button-accent-warm ml-1" @click="saveId">Look up</button>
      </div>
    </div>
</template>

<script>
import axios from 'axios';

export default ({
  data() {
    return {
      cveId: this.$store.state.cveId,
    };
  },
  created() {
    const fullPathArr = this.$route.fullPath.split('id=');
    if (fullPathArr.length === 2 && this.isInitialState) {
      const cveId = fullPathArr[1];
      console.log("cveId", cveId)
      this.$store.commit('setCVEId', cveId);
      this.cveId = cveId;
      this.lookupId();
    }
  },
  methods: {
    saveId() {
      this.$store.commit('setCVEId', this.cveId.trim());

      this.lookupId();
    },
    isInitialState() {
      return !!((this.$store.state.cveId.length === 0 && !this.$store.state.error
      && Object.keys(this.$store.state.cveRecord).length === 0 && this.$store.state.cveRecord.constructor === Object));
    },
    resetStates() {
      this.$store.commit('setError', false);
      this.$store.commit('setIsLoading', true);
      this.$store.commit('setRecordData', {});
      this.$store.commit('setServerError', false);
    },
    lookupId() {
      const self = this;
      this.resetStates();

      const url = `https://api.github.com/search/code?q=${this.$store.state.cveId}+repo:CVEProject/cvelist+extension:json`;

      axios
        // TO DO: replace w/ CVE Services endpoint
        .get(url, { timeout: 30000 })
        .then((res) => {
          if (res.data.total_count < 1) {
            self.$store.commit('setError', true);
          } else if (res.data.total_count === 1) {
            self.$store.commit('setRecordData', res.data.items);
          } else {
            self.$store.commit('setRecordData', res.data.items.splice(0, 10));
          }

          self.$store.commit('setIsLoading', false);
        })
        .catch(() => {
          this.$store.commit('setServerError', true);
        })
        .finally(() => {
          const fullPathArr = this.$route.fullPath.split('id=');
          const cveId = fullPathArr[1];

          console.log('finally')
          if (this.$route.name !== 'CVERecord' || (this.$store.state.cveId.length > 0) && cveId !== this.$store.state.cveId) {
            this.$router.push(`/CVERecord?id=${this.$store.state.cveId}`);
            console.log('this.$router.push(`/CVERecord?id=${this.$store.state.cveId}`);')
          }
            
        });
    },
    isURLParamSameAsCVEId(){

    }
  },
});
</script>

<style scoped lang="scss">
@import '../assets/style/globals.scss';
</style>
