<template>
  <div id="cve-secondary-page-main-container">
    <div class="columns is-centered">
      <div class="column is-8-desktop cve-main-column-content-width">
        <main id="cve-main-page-content" role="main">
          <div class="content">
          <button class="button" @click="showFakeData">Show fake data</button>
          <div class="loader-wrapper is-active" v-if="this.$store.state.isSearching">
            <p class="is-size-5">Please wait. Loading...</p>
            <p class="loader is-loading mb-4 ml-1"></p>
          </div>
          <div v-else>
            <div v-if="this.$store.state.serverError" style="text-align: center;">
              <h1 class="title is-4">Service is currently unavailable.</h1>
              <p style="text-align: center;">Please
                <span class="icon-text">
                  <a href="https://cveform.mitre.org/" target="_blank">report the issue
                    <span class="icon is-size-7 cve-icon-xxs">
                      <p id="extenalLink1" class="is-hidden">external site</p>
                      <font-awesome-icon icon="external-link-alt" aria-labelledby="extenalLink1" aria-hidden="false" focusable="false"/>
                    </span>
                  </a>
                </span>
                and try again later. Sorry for the inconvenience.
              </p>
            </div>
            <p v-if="this.$store.state.showHelpText" style="text-align: center;">
              Please use the search box above to find a CVE record by ID.
            </p>
            <div v-if="!this.$store.state.isSearching && !this.$store.state.showHelpText && !this.$store.state.serverError">
              <div v-if="this.$store.state.error" style="text-align: center !important">
                <h1 class="title is-3 is-4 mb-2">{{this.$store.state.cveId}} not found.</h1>
                <span class="icon-text">
                  <a href="https://cve.mitre.org/cve/search_cve_list.html" target="_blank">
                  Find CVE Record by Keyword
                  <span class="icon cve-icon-xxs" style="margin-left: 0px;">
                    <p id="CVERecordsKeywordSearch" class="is-hidden">external site</p>
                    <font-awesome-icon icon="external-link-alt" aria-labelledby="CVERecordsKeywordSearch">
                    </font-awesome-icon>
                  </span>
                  </a>
                </span>
              </div>
              <div v-else>
                <h1 class="title">{{this.$store.state.recordData.cveMetadata.cveId}}
                  <span v-if="cveFieldList.Title" class="ml-2">{{cveFieldList.Title.content}}</span>
                </h1>
                <div class="columns">
                  <div class="column">
                    <div class="has-text-weight-bold">Assigner: {{cveFieldList.CNA.content}}</div>
                    <div>
                      <span v-if="cveFieldList.CNADatePublished">Published: {{cveFieldList.CNADatePublished.content}}</span>
                      <span v-if="cveFieldList.CNADateUpdated">Updated: {{cveFieldList.CNADateUpdated.content}}</span>
                      <span v-for="(tagStr) in cveFieldList.Tags.content" :key="tagStr" classes="cveFieldList.Tags.classes">{{tagStr}}</span>
                    </div>
                  </div>
                  <div class="column">
                    <div><!-- blank field to align with left column field --></div>
                    <div class="buttons is-right" @click="showJsonModal=true">
                      <button id="cve-json-modal-button" class="button modal-button cve-button-ghost"
                        data-target="#json-modal" aria-haspopup="true">
                        View Full JSON 5.0 Record
                      </button>
                    </div>
                  </div>
                </div>
                <div v-if="showJsonModal" class="modal is-active">
                  <div class="modal-background"></div>
                  <div class="modal-content">
                    <div class="message-body">
                      <pre>{{JSON.stringify(this.$store.state.recordData, null, 2)}}</pre>
                    </div>
                  </div>
                  <button class="modal-close is-large" aria-label="close" @click="showJsonModal=false"></button>
                </div>
                <p><!-- description --></p>
                <div id="cve-product-status-container">
                  <!-- product status tables -->
                </div>
                <!-- add credits -->
                <!-- add references -->
                <div>
                  <span>View additional information about
                    <a :href="NVDUrl" target='_blank'>
                      {{this.$store.state.recordData.cveMetadata.cveId}}
                      <span class='icon cve-icon-xxs'>
                        <p id='nvd' class='is-hidden'>external site</p>
                          <font-awesome-icon icon='external-link-alt' aria-labelledby='nvd'>
                          </font-awesome-icon>
                      </span>
                    </a>
                    on NVD.
                  </span>
                  <p class='cve-help-text'>(Note: The NVD is not operated by the CVE Program)</p>
                </div>
                <!-- add record level dates -->
              </div>
            </div>
          </div>
          </div>
        </main>
      </div>
    </div>
  </div>
</template>

<script>
import advancedExample from '@/assets/data/tmpAdvanced5Example.json';

export default {
  name: 'CVERecord5',
  data() {
    return {
      showJsonModal: false,
      cveRecordFields: ['CNA', 'Description', 'Problem Type', 'CNADatePublic', 'CNADateUpdated',
        'References', 'State', 'Tags', 'Title', 'Vendors, Products & Versions'],
    };
  },
  computed: {
    cveFieldList() {
      const fieldsWithData = {};
      this.cveRecordFields.forEach((field) => {
        const fieldData = this.getContentForField(field);
        if (fieldData) {
          fieldsWithData[field] = fieldData;
        }
      });
      return fieldsWithData;
    },
    NVDUrl() {
      return `https://nvd.nist.gov/view/vuln/detail?vulnId=${this.$store.state.recordData.cveMetadata.cveId}`;
    },
  },
  methods: {
    // SRL - remove showFakeData when JSON 5.0 service is ready
    showFakeData() {
      this.$store.commit('updateState', { showHelpText: false, isSearching: false, serverError: false });
      this.$store.state.recordData = advancedExample;
    },
    formatDate(dateStr) { // TODO - consider moving to a mixin to use throughout the website
      const yyyymmdd = dateStr.split('-');
      const formattedDate = new Date();
      formattedDate.setFullYear(parseInt(yyyymmdd[0], 10));
      formattedDate.setMonth(parseInt(yyyymmdd[1] - 1, 10));
      formattedDate.setDate(parseInt(yyyymmdd[2], 10));
      const options = { year: 'numeric', month: 'numeric', day: 'numeric' };
      return formattedDate.toISOString(undefined, options).substring(0, 10);
    },
    getCNA(recordData) {
      return (recordData.cveMetadata.assignerShortName) ? recordData.cveMetadata.assignerShortName : '';
    },
    getCNADatePublic(recordData) {
      return (recordData.containers.cna.datePublic) ? this.formatDate(recordData.containers.cna.datePublic) : '';
    },
    getCNADateUpdated(recordData) {
      return (recordData.containers.cna.providerMetadata.dateUpdated) ? this.formatDate(recordData.containers.cna.providerMetadata.dateUpdated) : '';
    },
    getDescription(recordData) {
      const content = [];
      if (recordData.containers.cna.descriptions.length > 0) {
        recordData.containers.cna.descriptions.forEach((desc) => {
          content.push(desc.value);
        });
      }
      return content;
    },
    getProblemType(recordData) {
      const content = ['test', 'test2', 'test3', 'test4', 'test5'];
      if (recordData.containers.cna.problemTypes.length > 0) {
        recordData.containers.cna.problemTypes.forEach((type) => {
          type.descriptions.forEach((desc) => {
            content.push(desc.description);
          });
        });
      }
      return { content, classes: 'tag is-rounded has-text-grey-dark is-capitalized' };
    },
    getReferences(recordData) {
      const content = [];
      const thisItem = {};
      recordData.containers.cna.references.forEach((ref) => {
        if (ref.url !== undefined) {
          thisItem.content = `<a :href='${ref.url}' class='cve-word-wrap' target='_blank'>${
            ref.url
          }</a>`;
          content.push(thisItem);
        }
      });
      return content;
    },
    getState(recordData) {
      return (recordData.cveMetadata.state) ? recordData.cveMetadata.state : '';
    },
    // SRL - need to add; don't know where to find these yet
    getTags(recordData) {
      let content = [];
      if (Object.prototype.hasOwnProperty.call(recordData.containers.cna, 'tags')) {
        content = recordData.containers.cna.tags;
      }
      return { content, classes: 'tag is-rounded has-text-grey-dark is-capitalized' };
    },
    getTitle(recordData) {
      return recordData.containers.cna.title;
    },
    getAffectedVersions(versions) {
      let content = '';
      versions.forEach((version) => {
        if (version.status === 'affected') {
          content += "<li class='ml-5'>";
          content += 'Still working out what goes here';
          content += '</li>';
        }
      });
      if (content.length > 0) {
        content = `<ul>${content}</ul>`;
      }
      return content;
    },
    getVendorsProductsVersions(recordData) {
      const content = [];
      const thisItem = {};
      let contentStr = '';
      thisItem.classes = 'cve-list-no-bullet';
      recordData.containers.cna.affected.forEach((entry) => {
        contentStr = "<span class='has-text-weight-bold'>Vendor: </span>";
        contentStr += (entry.vendor === 'n/a') ? "<span class='is-italic'>Not Specified</span>" : `<span>${entry.vendor}</span>`;

        contentStr += "<ul class='mb-2'>";
        contentStr += (entry.product !== undefined) ? `<li class='cve-list-no-bullet'><span class='has-text-weight-bold'>
          Product: </span><span>${entry.product}</span></li>` : '';
        const affectedVersions = this.getAffectedVersions(entry.versions);
        contentStr += (affectedVersions.length > 0) ? `<li class='cve-list-no-bullet'><span class='has-text-weight-bold'>Versions Affected: </span>${
          affectedVersions}</li>` : '';
        thisItem.content = contentStr;
        content.push(thisItem);
      });
      return content;
    },
    getContentForField(field) {
      let fieldData = { fieldLabel: field };
      let additionalfieldData = {};
      const { recordData } = this.$store.state;
      switch (field) {
        case 'CNA':
          fieldData.content = this.getCNA(recordData);
          break;
        case 'CNADatePublic':
          fieldData.content = this.getCNADatePublic(recordData);
          break;
        case 'CNADateUpdated':
          fieldData.content = this.getCNADateUpdated(recordData);
          break;
        case 'Description':
          fieldData.content = this.getDescription(recordData);
          break;
        case 'Problem Type':
          additionalfieldData = this.getProblemType(recordData);
          fieldData.content = additionalfieldData.content;
          fieldData.itemClasses = additionalfieldData.classes;
          break;
        case 'References':
          fieldData.content = this.getReferences(recordData);
          break;
        case 'State':
          fieldData.content = this.getState(recordData);
          break;
        case 'Tags':
          additionalfieldData = this.getTags(recordData);
          fieldData.content = additionalfieldData.content;
          fieldData.itemClasses = additionalfieldData.classes;
          break;
        case 'Title':
          fieldData.content = this.getTitle(recordData);
          break;
        case 'Vendors, Products & Versions':
          fieldData.content = this.getVendorsProductsVersions(recordData);
          break;
        default:
          fieldData = undefined;
      }
      return fieldData;
    },
    toggleRecord() {
      this.$store.commit('updateState', { showJsonRecord: !this.$store.state.showJsonRecord });
    },
  },
};

</script>

<style scoped lang="scss">
@import '@/assets/style/globals.scss';

#cve-json-modal-button {
  color: $theme-color-primary !important;
  font-weight: bold;
}

pre {
  outline: 1px solid $theme-color-primary-darker; padding: 5px; margin: 5px;
  white-space: pre-wrap !important;
}

.loader-wrapper {
  background: #fff;
  opacity: 0;
  z-index: -1;
  transition: opacity .3s;
  display: flex;
  justify-content: center;
  align-items: center;

  &.is-active {
      opacity: 1;
      z-index: 1;
  }
}

</style>
