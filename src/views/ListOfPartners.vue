<template>
  <main id="cve-main-content" role="main">
    <div class="container cve-main-container">
      <div class="columns">
        <div class="column is-2">
        </div>
        <div class="column is8">
          <h2 class="title">List of Partners</h2>
          <div class="field">
            <label for="cve-partner-sort-select">Sort By:</label>
            <div class="control select">
              <select id="cve-partner-sort-select" v-model="sortBy">
                <option v-bind:value='{field: "organizationName", direction: "asc"}' selected="">Partner (asc)</option>
                <option v-bind:value='{field: "organizationName", direction: "desc"}'>Partner (desc)</option>
              </select>
            </div>
          </div>
          <div class="box">
            <div class="table-container">
              <table class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth cve-table">
                <thead>
                  <tr>
                      <th>Partner</th>
                      <th>CNA Type</th>
                      <th>Scope</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(CNA, index) in pagination.currentCNAstoDisplay" :key="index">
                    <td>{{CNA.organizationName}}<br/><a :href="'#/PartnerInformation/ListOfPartners/partner/'+CNA.shortName">View More</a></td>
                    <td>{{CNA.CNA.type.join(', ')}}</td>
                    <td>{{CNA.scope}}</td>
                  </tr>
                </tbody>
              </table>
              <nav class="pagination is-centered" role="navigation" aria-label="pagination">
                <button class ="pagination-previous cve-primary-button" v-bind:disabled="pagination.currentPage > 1 ? false : true" @click=getPreviousPage>
                  <font-awesome-icon icon="angle-left" /></button>    
                <button class ="pagination-next cve-primary-button" v-bind:disabled="pagination.currentPage >= pagination.totalPages ? true : false" 
                  @click=getNextPage><font-awesome-icon icon="angle-right" /></button>    
                <ul class ="pagination-list" >
                  <li v-for="(pageNumber, index) in pagination.pages" :key="index">
                    <a v-bind:class="pageNumber == pagination.currentPage ? 'pagination-link cve-primary-button is-current' : 'pagination-link cve-primary-button'" @click=updatePagination(pageNumber)
                      v-bind:aria-label="'Goto page ' + pageNumber" 
                      v-bind:aria-current="(pageNumber == pagination.currentPage) ? 'page' : false">{{pageNumber}}</a>
                  </li> 
                </ul>
              </nav>
            </div>
          </div>
        </div>
        <div class="column is-2">
        </div>
      </div>
    </div>
  </main>
</template>

<script>
import CNAData from '@/assets/data/CNAsList.json'

export default {
  
  data() {
    return {
      CNAsList: CNAData,
      sortBy: {
        field: 'organizationName',
        direction: 'asc'
      },
      pagination: {
        totalItems: 0,
        currentPage: 1,
        pageSize: 4,
        totalPages: 0,
        startIndex: 0,
        endIndex: 0,
        maxPages: 3,
        pages: [],
        currentCNAstoDisplay: [],
      }
    };
  },
  created() {
    this.sortedCNAs();
    this.paginate();
  },
  watch: {
    sortBy: function () {
      this.sortedCNAs();
    }
  },
  computed: {
    totalPages () {
      return Math.ceil(this.CNAsList.length / this.pagination.pageSize)
    },
  },
  methods: {
    sortedCNAs () {
      
      let sortModifier = (this.sortBy.direction === 'asc') ? 1 : -1;
      this.CNAsList.sort((CNA1, CNA2) => {
        let upperCasedValue1 = CNA1[this.sortBy.field].toUpperCase();
        let upperCasedValue2 = CNA2[this.sortBy.field].toUpperCase();
        if (upperCasedValue1 < upperCasedValue2) {
          return -1 * sortModifier;
        }
        if (upperCasedValue1 > upperCasedValue2) {
          return 1 * sortModifier;
        }
        return 0
      });

      this.paginate();
    },
    paginate () {
      // calculate total pages
      this.pagination.totalItems = this.CNAsList.length;
      let totalPages = Math.ceil( this.pagination.totalItems / this.pagination.pageSize);

      // ensure current page isn't out of range
      if (this.pagination.currentPage < 1) {
          this.pagination.currentPage = 1;
      } else if (this.pagination.currentPage > totalPages) {
          this.pagination.currentPage = totalPages;
      }

      let startPage, endPage;
      if (totalPages <= this.pagination.maxPages) {
          // total pages less than max so show all pages
          startPage = 1;
          endPage = totalPages;
      } else {
          // total pages more than max so calculate start and end pages
          let maxPagesBeforeCurrentPage = Math.floor(this.pagination.maxPages / 2);
          let maxPagesAfterCurrentPage = Math.ceil(this.pagination.maxPages / 2) - 1;
          if (this.pagination.currentPage <= maxPagesBeforeCurrentPage) {
              // current page near the start
              startPage = 1;
              endPage = this.pagination.maxPages;
          } else if (this.pagination.currentPage + maxPagesAfterCurrentPage >= totalPages) {
              // current page near the end
              startPage = totalPages - this.pagination.maxPages + 1;
              endPage = totalPages;
          } else {
              // current page somewhere in the middle
              startPage = this.pagination.currentPage - maxPagesBeforeCurrentPage;
              endPage = this.pagination.currentPage + maxPagesAfterCurrentPage;
          }
      }

      // calculate start and end item indexes
      this.pagination.startIndex = (this.pagination.currentPage - 1) * this.pagination.pageSize;
      this.pagination.endIndex = Math.min(this.pagination.startIndex + this.pagination.pageSize - 1, this.pagination.totalItems - 1);

      // create an array of pages to loop through in the pager control
      this.pagination.pages = Array.from(Array((endPage + 1) - startPage).keys()).map(i => startPage + i);
      this.pagination.totalPages = totalPages;

      this.pagination.currentCNAstoDisplay = this.CNAsList.slice(this.pagination.startIndex, this.pagination.endIndex + 1);
    },
    updatePagination (pageNumber) {
      this.pagination.currentPage = pageNumber;
      this.paginate();
    },
    getPreviousPage () {
      this.pagination.currentPage -= 1;   
      this.paginate();
    },
    getNextPage () {
      this.pagination.currentPage += 1;
      this.paginate();
    }
  },
};
</script>

<style <style scoped lang="scss">
@import '../assets/style/globals.scss';

.cve-main-container {
    text-align: left;
}

label {
    padding-right: 10px;
}

table {
    text-align: left;
}

.box {
    background-color: unset;
    border-radius: unset;
    box-shadow: unset;
    color: unset;
}
</style>
