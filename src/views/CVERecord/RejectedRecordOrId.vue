<template>
  <div class="content">
    <nav class="level">
      <!-- Left side -->
      <div class="level-left">
        <div class="level-item">
          <h1 class="title">{{cveFieldList.cveId}}</h1>
        </div>
        <div v-if="cveFieldList.state.length > 0" class="level-item">
          <span class="tag is-info">{{cveFieldList.state}}</span>
        </div>
      </div>
    </nav>
    <p v-if="cveFieldList.assigner.length > 0" class="mb-0">
      <span class="has-text-weight-bold" style="text-transform: capitalize;">Assigner: </span>
      <span style="text-transform: capitalize;">{{cveFieldList.assigner}}</span>
    </p>
    <p v-if="cveFieldList.dateUpdatedCna.length > 0" class="cve-gray-text">
      <span>Updated: </span>
      <time>{{cveFieldList.dateUpdatedCna}}</time>
    </p>
    <p>
      <span class="has-text-weight-bold">Rejected Reason:</span>
      <span>
        <span v-if="cveFieldList.rejectedReasons.length == 0">
          This CVE ID was unused by the <router-link to="/ProgramOrganization/CNAs">CNA</router-link>.
        </span>
        <span v-else>
          <span v-for="rejectedReason in cveFieldList.rejectedReasons" :key="rejectedReason.index">
            {{rejectedReason}}
          </span>
        </span>
      </span>
    </p>
    <div class="level-right">
        <div v-if="cveFieldList.dateRejectedCveMetadata" class="level-item cve-gray-text">
          <span>{{isArecord ? 'Record' : 'ID'}} Rejected: {{cveFieldList.dateRejectedCveMetadata}}</span>
        </div>
        <div v-if="cveFieldList.dateUpdatedCveMetadata" class="level-item cve-gray-text">
          <span>{{isArecord ? 'Record' : 'ID'}} Udated: {{cveFieldList.dateUpdatedCveMetadata}}</span>
        </div>
    </div>
  </div>
</template>

<script>
export default ({
  props: {
    isArecord: {
      type: Boolean,
      required: true,
    },
  },
  data() {
    return {
      cveFieldList: {
        cveId: '',
        state: '',
        dateUpdatedCna: '',
        assigner: '',
        rejectedReasons: [],
        dateUpdatedCveMetadata: '',
        dateRejectedCveMetadata: '',
      },
      originalRecordData: this.$store.state.recordData || {},
    };
  },
  mounted() {
    this.populatedCveFieldList();
  },
  methods: {
    populatedCveFieldList() {
      // TODO: Update logic to support both record and ID
      this.getCVEid();
      this.getState();
      this.getDateUpdatedCna();
      this.getAssigner();
      this.getRejectedReason();
      this.getDateUpdatedCveMetadata();
      this.getDateRejectedCveMetadata();
    },
    getCVEid() {
      if (this.originalRecordData.cveMetadata.cveId.length > 0) {
        this.cveFieldList.cveId = this.originalRecordData.cveMetadata.cveId;
      } else {
        this.cveFieldList.cveId = 'ID Not Found';
      }
    },
    getState() {
      if (this.originalRecordData.cveMetadata.state.length > 0) {
        this.cveFieldList.state = this.originalRecordData.cveMetadata.state;
      }
    },
    getDateUpdatedCna() {
      const value = this.getNestedObjValue(this.originalRecordData, 'containers', 'cna', 'providerMetadata', 'dateUpdated');
      if (value !== undefined && this.originalRecordData.containers.cna.providerMetadata.dateUpdated.length !== 0) {
        this.cveFieldList.dateUpdatedCna = this.getDate(value);
      }
    },
    getAssigner() {
      const value = this.getNestedObjValue(this.originalRecordData, 'cveMetadata', 'assignerShortName');
      if (value !== undefined && this.originalRecordData.cveMetadata.assignerShortName.length !== 0) {
        this.cveFieldList.assigner = value.replace('_', ' ');
      }
    },
    getRejectedReason() {
      const value = this.getNestedObjValue(this.originalRecordData, 'containers', 'cna', 'rejectedReasons');
      if (value.length > 0) {
        value.forEach((rejectReason) => {
          if (rejectReason.lang === 'en') this.cveFieldList.rejectedReasons.push(rejectReason.value);
        });
      }
    },
    getDateUpdatedCveMetadata() {
      const value = this.getNestedObjValue(this.originalRecordData, 'cveMetadata', 'dateUpdated');
      if (value.length > 0) {
        this.cveFieldList.dateUpdatedCveMetadata = this.getDate(value);
      }
    },
    getDateRejectedCveMetadata() {
      const value = this.getNestedObjValue(this.originalRecordData, 'cveMetadata', 'dateRejected');
      if (value.length > 0) {
        this.cveFieldList.dateRejectedCveMetadata = this.getDate(value);
      }
    },
    /**
     * Get value if key exists in a nested JSON
     * @return {String | undefined} Returns a string value if keys exist, else undefined
     * */
    getNestedObjValue(obj, ...args) {
      console.log(obj, ...args);
      return args.reduce((obj, level) => obj && obj[level], obj);
    },
    getDate(dateTime) {
      const [date] = dateTime.split('T');
      return date;
    },
  },
});
</script>
