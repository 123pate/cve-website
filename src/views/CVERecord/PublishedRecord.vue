<template>
  <div>
    <h1 class="title">{{this.$store.state.recordData.cveMetadata.cveId}}
      <span v-if="cveFieldList.Title" class="ml-2">{{cveFieldList.Title.content}}</span>
    </h1>
    <div class="container has-text-right ">
      <router-link :to="`api/?action=getCveById&cveId=${this.$store.state.recordData.cveMetadata.cveId}`" target="_blank">
        View JSON
      </router-link>
    </div>
    <div class="cna-container">
      <div class="has-text-weight-bold">
        Assigner: {{cveFieldList.CNA.content}}
      </div>
      <div>
        <span v-if="cveFieldList.CNADatePublished">Published: {{cveFieldList.CNADatePublished.content}}</span>
        <span v-if="cveFieldList.CNADateUpdated">Updated: {{cveFieldList.CNADateUpdated.content}}</span>
        <span v-for="(tagStr) in cveFieldList.Tags.content" :key="tagStr" classes="cveFieldList.Tags.classes">{{tagStr}}</span>
      </div>
    </div>
    <p><!-- description --></p>
    <div id="cve-product-status-container">
      <!-- product status tables -->
    </div>
    <!-- add credits -->
    <!-- add references -->
    <div>
      <span>View additional information about
        <a :href="NVDUrl" target='_blank'>
          {{this.$store.state.recordData.cveMetadata.cveId}}
          <span class='icon cve-icon-xxs'>
            <p id='nvd' class='is-hidden'>external site</p>
              <font-awesome-icon icon='external-link-alt' aria-labelledby='nvd'>
              </font-awesome-icon>
          </span>
        </a>
        on NVD.
      </span>
      <p class='cve-help-text'>(Note: The NVD is not operated by the CVE Program)</p>
    </div>
    <!-- add record level dates -->
  </div>
</template>

<script>
export default ({
  name: 'PublishedRecord',
  data() {
    return {
      cveRecordFields: ['CNA', 'Description', 'Problem Type', 'CNADatePublic', 'CNADateUpdated',
        'References', 'State', 'Tags', 'Title', 'Vendors, Products & Versions'],
      showJsonModal: false,
      NVDUrl: `https://nvd.nist.gov/view/vuln/detail?vulnId=${this.$store.state.recordData.cveMetadata.cveId}`,
    };
  },
  computed: {
    cveFieldList() {
      const fieldsWithData = {};
      this.cveRecordFields.forEach((field) => {
        const fieldData = this.getContentForField(field);
        if (fieldData) {
          fieldsWithData[field] = fieldData;
        }
      });
      return fieldsWithData;
    },
  },
  methods: {
    formatDate(dateStr) { // TODO - consider moving to a mixin to use throughout the website
      const yyyymmdd = dateStr.split('-');
      const formattedDate = new Date();
      formattedDate.setFullYear(parseInt(yyyymmdd[0], 10));
      formattedDate.setMonth(parseInt(yyyymmdd[1] - 1, 10));
      formattedDate.setDate(parseInt(yyyymmdd[2], 10));
      const options = { year: 'numeric', month: 'numeric', day: 'numeric' };
      return formattedDate.toISOString(undefined, options).substring(0, 10);
    },
    getCNA(recordData) {
      return (recordData.cveMetadata.assignerShortName) ? recordData.cveMetadata.assignerShortName : '';
    },
    getCNADatePublic(recordData) {
      return (recordData.containers.cna.datePublic) ? this.formatDate(recordData.containers.cna.datePublic) : '';
    },
    getCNADateUpdated(recordData) {
      return (recordData.containers.cna.providerMetadata.dateUpdated) ? this.formatDate(recordData.containers.cna.providerMetadata.dateUpdated) : '';
    },
    getDescription(recordData) {
      const content = [];
      if (recordData.containers.cna.descriptions.length > 0) {
        recordData.containers.cna.descriptions.forEach((desc) => {
          content.push(desc.value);
        });
      }
      return content;
    },
    getProblemType(recordData) {
      const content = ['test', 'test2', 'test3', 'test4', 'test5'];
      if (recordData.containers.cna.problemTypes.length > 0) {
        recordData.containers.cna.problemTypes.forEach((type) => {
          type.descriptions.forEach((desc) => {
            content.push(desc.description);
          });
        });
      }
      return { content, classes: 'tag is-rounded has-text-grey-dark is-capitalized' };
    },
    getReferences(recordData) {
      const content = [];
      const thisItem = {};
      recordData.containers.cna.references.forEach((ref) => {
        if (ref.url !== undefined) {
          thisItem.content = `<a :href='${ref.url}' class='cve-word-wrap' target='_blank'>${
            ref.url
          }</a>`;
          content.push(thisItem);
        }
      });
      return content;
    },
    getState(recordData) {
      return (recordData.cveMetadata.state) ? recordData.cveMetadata.state : '';
    },
    // SRL - need to add; don't know where to find these yet
    getTags(recordData) {
      let content = [];
      if (Object.prototype.hasOwnProperty.call(recordData.containers.cna, 'tags')) {
        content = recordData.containers.cna.tags;
      }
      return { content, classes: 'tag is-rounded has-text-grey-dark is-capitalized' };
    },
    getTitle(recordData) {
      return recordData.containers.cna.title;
    },
    getAffectedVersions(versions) {
      let content = '';
      versions.forEach((version) => {
        if (version.status === 'affected') {
          content += "<li class='ml-5'>";
          content += 'Still working out what goes here';
          content += '</li>';
        }
      });
      if (content.length > 0) {
        content = `<ul>${content}</ul>`;
      }
      return content;
    },
    getVendorsProductsVersions(recordData) {
      const content = [];
      const thisItem = {};
      let contentStr = '';
      thisItem.classes = 'cve-list-no-bullet';
      recordData.containers.cna.affected.forEach((entry) => {
        contentStr = "<span class='has-text-weight-bold'>Vendor: </span>";
        contentStr += (entry.vendor === 'n/a') ? "<span class='is-italic'>Not Specified</span>" : `<span>${entry.vendor}</span>`;

        contentStr += "<ul class='mb-2'>";
        contentStr += (entry.product !== undefined) ? `<li class='cve-list-no-bullet'><span class='has-text-weight-bold'>
          Product: </span><span>${entry.product}</span></li>` : '';
        const affectedVersions = this.getAffectedVersions(entry.versions);
        contentStr += (affectedVersions.length > 0) ? `<li class='cve-list-no-bullet'><span class='has-text-weight-bold'>Versions Affected: </span>${
          affectedVersions}</li>` : '';
        thisItem.content = contentStr;
        content.push(thisItem);
      });
      return content;
    },
    getContentForField(field) {
      let fieldData = { fieldLabel: field };
      let additionalfieldData = {};
      const { recordData } = this.$store.state;
      switch (field) {
        case 'CNA':
          fieldData.content = this.getCNA(recordData);
          break;
        case 'CNADatePublic':
          fieldData.content = this.getCNADatePublic(recordData);
          break;
        case 'CNADateUpdated':
          fieldData.content = this.getCNADateUpdated(recordData);
          break;
        case 'Description':
          fieldData.content = this.getDescription(recordData);
          break;
        case 'Problem Type':
          additionalfieldData = this.getProblemType(recordData);
          fieldData.content = additionalfieldData.content;
          fieldData.itemClasses = additionalfieldData.classes;
          break;
        case 'References':
          fieldData.content = this.getReferences(recordData);
          break;
        case 'State':
          fieldData.content = this.getState(recordData);
          break;
        case 'Tags':
          additionalfieldData = this.getTags(recordData);
          fieldData.content = additionalfieldData.content;
          fieldData.itemClasses = additionalfieldData.classes;
          break;
        case 'Title':
          fieldData.content = this.getTitle(recordData);
          break;
        case 'Vendors, Products & Versions':
          fieldData.content = this.getVendorsProductsVersions(recordData);
          break;
        default:
          fieldData = undefined;
      }
      return fieldData;
    },
    toggleRecord() {
      this.$store.commit('updateState', { showJsonRecord: !this.$store.state.showJsonRecord });
    },
  },
});
</script>
