 <template>
  <div class="content">
    <nav class="level mb-0">
      <div class="level-left">
        <div class="level-item">
          <h1 class="title">{{this.$store.state.cveId}}</h1>
        </div>
        <div v-if="cveFieldList.state.length > 0" class="level-item">
          <span class="tag is-info">{{cveFieldList.state}}</span>
        </div>
      </div>
      <div class="level-right ml-1">
        <div class="level-item">
          <a id="cve-view-json" :href="`https://${this.$store.state.CVE_SERVICES_API_BASE}/api/cve/${this.$store.state.cveId}`" target="_blank">
            View JSON
          </a>
        </div>
      </div>
    </nav>
    <div class="content"><span v-if="cveFieldList.title.length > 0" class="has-text-grey-dark is-size-6">{{cveFieldList.title}}</span></div>
    <div role="information" class="notification is-info is-light">
      <div class="is-flex" style="justify-content: center;">
        <p id="infoIconVariousFormts" class="is-hidden">information</p>
        <font-awesome-icon style="flex: 0 0 40px;" size="1x"  icon="info-circle" role="alert"
          aria-labelledby="alertIconVariousFormts" aria-hidden="false" />
        <div>
          <p><strong>IMPORTANT NOTIFICATION</strong></p>
          <p>
            As of October 6, 2022, <router-link to='/ResourcesSupport/Glossary?activeTerm=glossaryRecord'>CVE Records</router-link> on this cve.org
            website will be displayed in <a href='https://cveproject.github.io/automation-cve-services#json-overview' target='_blank'>CVE JSON 5.0</a>
            only. Downloads in this format will be introduced in 2023.
          </p>
          <p>
            During the transition period, CVE Records may still be viewed in CVE JSON 4.0 format on the
            <a href='https://github.com/CVEProject/cvelist' target='_blank'>CVE List GitHub pilot</a> website while the traditional CVE List download
            formats will continue to be available on the legacy <a href='https://cve.mitre.org' target='_blank'>cve.mitre.org</a> website.
            <router-link to='/Media/News/item/blog/2022/10/06/CVE-Records-Are-Now-Displayed'>Learn more here</router-link>.
          </p>
        </div>
      </div>
    </div>
    <div id="cve-cna-container" class="content">
      <p v-if="cveFieldList.assigner.length > 0" class="mb-0">
        <span class="has-text-weight-bold">Assigner: </span>
        <span style="text-transform: capitalize;">{{cveFieldList.assigner}}</span>
      </p>
      <div id="cve-record-dates-and-tags-container" class="has-text-grey-dark has-text-left">
        <span class="mr-2">
          <span  v-if="cveFieldList.datePublishedCveMetadata.length > 0">
            <span class="has-text-weight-semibold">Published: </span>
            <time>{{cveFieldList.datePublishedCveMetadata}}</time>
          </span>
          <span :class="cveFieldList.datePublishedCveMetadata.length > 0 ? 'ml-2' : ''" v-if="cveFieldList.dateUpdatedCveMetadata.length > 0">
            <span class="has-text-weight-semibold">Updated: </span>
            <time>{{cveFieldList.dateUpdatedCveMetadata}}</time>
          </span>
        </span>
        <span id="cve-tag " v-if="cveFieldList.tags.length > 0">
          <span class="has-text-grey-dark mr-2">|</span>
          <span class="tag is-info is-light" v-for="tag in cveFieldList.tags" :key="tag">{{tag}}</span>
        </span>
      </div>
    </div>
    <div id="cve-desciption" class="content has-text-justified">
      <p v-for="description in cveFieldList.descriptions" :key="description">{{description}}</p>
    </div>
    <div id="cve-product-status-container" class="content" v-if="cveFieldList.productsStatus.length > 0">
      <h2 class="title is-size-5">Product Status</h2>
      <div class="columns cve-row mb-4" v-for="(product, index) in cveFieldList.productsStatus" :key="`${index}-${product.vendor}`">
        <div id="cve-vendor-product-platforms" class="column is-4 cve-light-gray-bg">
          <p class="has-text-weight-bold">Vendor & Product</p>
          <p id="cve-vendor" v-if="product.vendor.length > 0">{{product.vendor}}</p>
          <p id="cve-product" v-if="product.product.length > 0">{{product.product}}</p>
          <p id="cve-platforms" v-if="product.platforms.length > 0">
            <span class="has-text-weight-bold">Platforms: </span>
            {{product.platforms.join(', ')}}
          </p>
        </div>
        <div class="column is-8 cve-light-gray-bg cve-left-margin cve-top-margin pt-0"
          v-for="table in product.affectedUnaffectedUnknownTable" :key="table.key">
          <div class="table-container">
            <table class="table is-striped is-hoverable cve-border-light-gray cve-border-bottom-unset">
              <thead>
                <tr>
                  <th class="cve-light-gray-table-header" v-for="header in table.headers" :key="header.key">{{header}}</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="row in table.twoDTable" :key="row.key">
                    <td data-label="affected" v-for="affectedCol in row.affected" :key="affectedCol.key">
                      <p v-for="version in affectedCol.versions" :key="version.key">
                        {{version}}
                      </p>
                      <p class="is-italic" v-for="change in affectedCol.changes" :key="change.key">
                        {{change}}
                      </p>
                    </td>
                    <td data-label="unaffected" v-for="unaffectedCol in row.unaffected" :key="unaffectedCol.key">
                      <p v-for="version in unaffectedCol.versions" :key="version.key">
                        {{version}}
                      </p>
                      <p class="is-italic" v-for="change in unaffectedCol.changes" :key="change.key">
                        {{change}}
                      </p>
                    </td>
                    <td data-label="unknown" v-for="unknown in row.unknown" :key="unknown.key">
                      <p v-for="version in unknown.versions" :key="version.key">
                        {{version}}
                      </p>
                      <p class="is-italic" v-for="change in unknown.changes" :key="change.key">
                        {{change}}
                      </p>
                    </td>
                  </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div id="cve-credits" class="content" v-if="cveFieldList.credits.length > 0">
      <h2 class="title is-size-5">Credits</h2>
      <ul>
        <li v-for="(credit, index) in cveFieldList.credits" :key="`${credit}-${index}`">
          {{credit.value}}
          <span class="tag ml-2" v-if="typeof credit.type !== 'undefined' && credit.type.length > 0">{{credit.type}}</span>
        </li>
      </ul>
    </div>
    <div id="cve-references" class="content" v-if="cveFieldList.references.length > 0">
      <h2 class="title is-size-5">References</h2>
      <ul>
        <li v-for="(reference, index) in cveFieldList.references" :key="`link-${index}`" class="cve-word-wrap">
          <span class="icon-text">
            <a :href="reference.url" target="_blank">
              {{ (typeof reference.name !== 'undefined' && reference.name.length > 0) ? reference.name : reference.url }}
              <span class="icon cve-icon-xxs">
                <p id="enewsletter" class="is-hidden">external site</p>
                <font-awesome-icon icon="external-link-alt" aria-labelledby="enewsletter"></font-awesome-icon>
              </span>
            </a>
          </span>
          <span v-for="tag in reference.tags" :key="tag">
            <span class="tag ml-2" v-if="tag.length > 0">{{tag}}</span>
          </span>
        </li>
      </ul>
    </div>
    <div id="cve-nvd-link">
      <span>View additional information about
        <a :href="`${NVDBaseUrl}${this.$store.state.cveId}`" target='_blank'>
          {{ this.$store.state.recordData.cveMetadata.cveId }}
          <span class='icon cve-icon-xxs'>
            <p id='nvd' class='is-hidden'>external site</p>
            <font-awesome-icon icon='external-link-alt' aria-labelledby='nvd'></font-awesome-icon>
          </span>
        </a>
        on NVD.
      </span>
      <p class='cve-help-text'>(Note: The NVD is not operated by the CVE Program)</p>
    </div>
  </div>
</template>

<script>
import Vue from 'vue';
import _ from 'lodash';

export default ({
  name: 'PublishedRecord',
  props: {
    NVDBaseUrl: {
      type: String,
      required: true,
    },
  },
  data() {
    return {
      cveRecordFields: ['ID', 'CNA', 'Credits', 'Description', 'References', 'State', 'Tags', 'Title', 'VendorsProductsVersions',
        'RecordPublishedDate', 'RecordUpdatedDate'],
      cveFieldList: {
        cveId: '',
        credits: [],
        descriptions: [],
        productsStatus: [],
        title: '',
        state: '',
        assigner: '',
        dateUpdatedCveMetadata: '',
        datePublishedCveMetadata: '',
        references: [],
        tags: [],
      },
      originalRecordData: this.$store.state.recordData || {},
    };
  },
  methods: {
    initializeFields() {
      this.cveRecordFields.forEach((field) => {
        this.getContentForField(field);
      });
    },
    getCNA() {
      const value = this.originalRecordData.cveMetadata?.assignerShortName;
      if (this.hasData(value)) {
        this.cveFieldList.assigner = value.replace('_', ' ');
      }
    },
    getCredits() {
      // schema: https://github.com/CVEProject/cve-schema/blob/master/schema/v5.0/CVE_JSON_5.0_schema.json#L971-L1015
      const value = this.originalRecordData.containers?.cna?.credits;
      if (this.hasData(value)) {
        value.forEach((credit) => {
          if (this.isEnglishLanguage(credit.lang)) {
            this.cveFieldList.credits.push(credit);
          }
        });
      }
    },
    getRecordPublishedDate() {
      const value = this.originalRecordData.cveMetadata?.datePublished;
      if (this.hasData(value)) {
        this.cveFieldList.datePublishedCveMetadata = this.getDate(value);
      }
    },
    getRecordUpdatedDate() {
      const value = this.originalRecordData.cveMetadata?.dateUpdated;
      if (this.hasData(value)) {
        this.cveFieldList.dateUpdatedCveMetadata = this.getDate(value);
      }
    },
    getCVEid() {
      const value = this.originalRecordData.cveMetadata?.cveId;
      if (this.hasData(value)) {
        this.cveFieldList.cveId = value;
      } else {
        this.cveFieldList.cveId = this.$store.state.recordData.cveMetadata.cveId; // user-provided CVE ID
      }
    },
    getDescription() {
      const value = this.originalRecordData.containers?.cna?.descriptions;
      if (this.hasData(value)) {
        value.forEach((desc) => {
          if (this.isEnglishLanguage(desc.lang)) {
            this.cveFieldList.descriptions.push(desc.value);
          }
        });
      }
    },
    getReferences() {
      const value = this.originalRecordData.containers?.cna?.references;
      if (this.hasData(value)) {
        const filteredReferences = [];
        const regex = /^x_refsource/;

        value.forEach((reference) => {
          let newReference = {};
          const filteredTags = [];

          if (reference?.tags) {
            reference.tags.forEach((tag) => {
              if (!regex.test(tag)) filteredTags.push(tag);
            });
          }
          newReference = _.cloneDeep(reference);
          newReference.tags = filteredTags;
          filteredReferences.push(newReference);
        });

        Vue.set(this.cveFieldList, 'references', filteredReferences);
      }
    },
    getState() {
      const value = this.originalRecordData.cveMetadata?.state;
      if (this.hasData(value)) {
        this.cveFieldList.state = value;
      }
    },
    getTags() {
      const value = this.originalRecordData.containers?.cna?.tags;
      if (this.hasData(value)) {
        Vue.set(this.cveFieldList, 'tags', value);
      }
    },
    getTitle() {
      const value = this.originalRecordData.containers?.cna?.title;
      if (this.hasData(value)) {
        this.cveFieldList.title = value;
      }
    },
    // getProductsStatus() is adapted from https://github.com/Vulnogram/seaview/blob/main/script.js#L140-L53
    getProductsStatus() {
      const affectedList = this.originalRecordData.containers?.cna?.affected;
      if (this.hasData(affectedList)) {
        const prodStatusTemplate = {
          vendor: '',
          product: '',
          platforms: [],
          affectedUnaffectedUnknownTable: [],
          affected: [],
          unaffected: [],
          unknown: [],
        };

        /**
          Building the Product Status table each product in containers.cna.affected[]:
          - column 1: vendor, product, platforms
          - column 2: affected/unaffected/unknown table
        */
        affectedList.forEach((affectedObj) => {
          const prodStatus = _.cloneDeep(prodStatusTemplate);
          // Building column 1
          if (this.hasData(affectedObj?.vendor)) prodStatus.vendor = affectedObj.vendor;
          if (this.hasData(affectedObj?.product)) prodStatus.product = affectedObj.product;
          if (this.hasData(affectedObj?.platforms)) prodStatus.platforms = _.cloneDeep(affectedObj.platforms);

          const affectedUnaffectedUnknownTable = [];
          // https://github.com/Vulnogram/seaview/blob/main/script.js#L175-L216
          if (this.hasData(affectedObj?.versions)) {
            const tableRowTemplate = {
              affected: [],
              unaffected: [],
              unknown: [],
            };
            // Building column 2: an affected/unaffected/unknown row for each product version in containers.cna.affected[i].versions[].
            // Note the row can also contain "changes".
            affectedObj.versions.forEach((versionObj) => {
              const tableRow = _.cloneDeep(tableRowTemplate);
              const versionsAndChangesTemplate = {
                versions: [],
                changes: [],
              };
              const productVersion = `${versionObj?.version || '(no version provided)'}`;
              const versionStatus = versionObj?.status || 'noVersionStatus'; // affected, unaffected, OR unknown

              if (this.hasData(versionObj?.changes)) {
                let range = '';
                if (productVersion !== 'unspecified' && productVersion !== 0) range = `from ${productVersion} `;

                if (versionObj?.lessThan) {
                  let rangeEnd = `before ${versionObj?.lessThan || '(no lessThan version provided)'} `;
                  if (this.isUnspecifiedOrWildCard(versionObj, 'lessThan')) rangeEnd = '';
                  if ((rangeEnd.length > 0) && (versionObj.lessThan !== productVersion)) {
                    range += `${rangeEnd}`;
                  }
                } else if (versionObj?.lessThanOrEqual) {
                  let rangeEnd = `through ${versionObj?.lessThanOrEqual || '(no lessThan version provided)'} `;
                  if (this.isUnspecifiedOrWildCard(versionObj, 'lessThanOrEqual')) rangeEnd = '';
                  if ((rangeEnd.length > 0) && (versionObj.lessThanOrEqual !== productVersion)) {
                    range += `${rangeEnd}`;
                  }
                } else {
                  range = productVersion;
                }

                // save the version changes
                const versionsAndChangesCopy = _.cloneDeep(versionsAndChangesTemplate);
                versionsAndChangesCopy.versions.push(range);
                tableRow[versionStatus].push(versionsAndChangesCopy);

                // Build a temp 'changes' object by going through container.cna.affected[x].versions[x].changes[]
                //   and categorize by 'status' (affected, unaffected, or unknown)
                //   which can be different from the main 'status' (container.cna.affected[x].versions[x].status).
                const changes = {};
                versionObj.changes.forEach((change) => {
                  const changeAtVersion = `from ${change.at}`;
                  if (!Object.prototype.hasOwnProperty.call(changes, change.status)) {
                    changes[change.status] = [];
                  }
                  changes[change.status].push(changeAtVersion);
                });

                // Categorize each change in on the temp 'changes' object (from above) by it's change 'status'
                Object.entries(changes).forEach((change) => {
                  const [status, rangeList] = change;
                  const afftdUnafftdUknwnColumnLength = tableRow[status].length;
                  if (afftdUnafftdUknwnColumnLength === 0) {
                    const versionsAndChangesCopy1 = _.cloneDeep(versionsAndChangesTemplate);
                    versionsAndChangesCopy1.changes = rangeList;
                    tableRow[status][afftdUnafftdUknwnColumnLength] = versionsAndChangesCopy1;
                  } else {
                    tableRow[status][afftdUnafftdUknwnColumnLength - 1].changes = rangeList;
                  }
                });
              } else {
                let rangeStart = '';

                if (productVersion !== 'unspecified' && productVersion !== 0) rangeStart = `from ${productVersion}`;
                const versionsAndChangesCopy2 = _.cloneDeep(versionsAndChangesTemplate);

                if (this.hasData(versionObj?.lessThan)) {
                  let range = '';
                  let rangeEnd = `before ${versionObj?.lessThan || '(no version.lessThan provided)'}`;
                  if (this.isUnspecifiedOrWildCard(versionObj, 'lessThan')) rangeEnd = '';
                  if (rangeEnd.length > 0) {
                    range = `${rangeStart} ${rangeEnd}`;
                  } else {
                    range = `${rangeStart}`;
                  }

                  versionsAndChangesCopy2.versions.push(range);
                  tableRow[versionStatus].push(versionsAndChangesCopy2);
                } else if (this.hasData(versionObj?.lessThanOrEqual)) {
                  let range = '';
                  let rangeEnd = `through ${versionObj?.lessThanOrEqual || '(no version.lessThan provided)'}`;
                  if (this.isUnspecifiedOrWildCard(versionObj, 'lessThanOrEqual')) rangeEnd = '';
                  range = `${rangeStart} ${rangeEnd}`;

                  versionsAndChangesCopy2.versions.push(range);
                  tableRow[versionStatus].push(versionsAndChangesCopy2);
                } else {
                  versionsAndChangesCopy2.versions.push(`${productVersion}`);
                  tableRow[versionStatus].push(versionsAndChangesCopy2);
                }
              }

              affectedUnaffectedUnknownTable.push(tableRow);
            });
          }

          const tableWithHeaders = this.create2DTable(affectedUnaffectedUnknownTable);
          prodStatus.affectedUnaffectedUnknownTable.push(tableWithHeaders);
          this.cveFieldList.productsStatus.push(_.cloneDeep(prodStatus));
        });
      }
    },
    getContentForField(field) {
      switch (field) {
        case 'CNA':
          this.getCNA();
          break;
        case 'Credits':
          this.getCredits();
          break;
        case 'Description':
          this.getDescription();
          break;
        case 'ID':
          this.getCVEid();
          break;
        case 'RecordPublishedDate':
          this.getRecordPublishedDate();
          break;
        case 'RecordUpdatedDate':
          this.getRecordUpdatedDate();
          break;
        case 'References':
          this.getReferences();
          break;
        case 'State':
          this.getState();
          break;
        case 'Tags':
          this.getTags();
          break;
        case 'Title':
          this.getTitle();
          break;
        case 'VendorsProductsVersions':
          this.getProductsStatus();
          break;
        default:
          break;
      }
    },
    hasData(value) {
      if (typeof value !== 'undefined' && value.length > 0) {
        return true;
      }

      return false;
    },
    isEnglishLanguage(lang) {
      const regex = /^(en)/;
      const isEnglishLanguage = regex.test(lang);

      return isEnglishLanguage;
    },
    isUnspecifiedOrWildCard(field, key) {
      return (field[key] === 'unspecified' || field[key] === '*');
    },
    getDate(dateTime) {
      const [date] = dateTime.split('T');
      return date;
    },
    toggleRecord() {
      this.$store.commit('updateState', { showJsonRecord: !this.$store.state.showJsonRecord });
    },
    create2DTable(affectedUnaffectedUnknownTable) {
      const tableWithHeaders = {
        headers: [],
        twoDTable: [],
      };

      // Build table headers: affected, unaffected, and/or unknown
      affectedUnaffectedUnknownTable.forEach((row) => {
        if ((row.affected.length > 0) && (tableWithHeaders.headers.indexOf('affected') < 0)) tableWithHeaders.headers.push('affected');
        if ((row.unaffected.length > 0) && (tableWithHeaders.headers.indexOf('unaffected') < 0)) tableWithHeaders.headers.push('unaffected');
        if ((row.unknown.length > 0) && (tableWithHeaders.headers.indexOf('unknown') < 0)) tableWithHeaders.headers.push('uknown');
      });
      tableWithHeaders.headers.sort();

      // Build 2D table w/ 'version'&'changes' or '' for table cell w/ no value
      affectedUnaffectedUnknownTable.forEach((row) => {
        // for each row fill in 'version'&'changes' or ''
        const formattedRow = {};
        tableWithHeaders.headers.forEach((headerLabel) => {
          if (row?.[headerLabel].length > 0) {
            formattedRow[headerLabel] = row[headerLabel];
          } else {
            // empty cell
            formattedRow[headerLabel] = [{
              versions: [''],
              changes: [],
            }];
          }
        });
        tableWithHeaders.twoDTable.push(formattedRow);
      });
      return tableWithHeaders;
    },
  },
  beforeMount() {
    this.initializeFields();
  },
});
</script>

<style lang="scss" scoped>
@import '@/assets/style/globals.scss';
@import '@/assets/style/cveRecord.scss';
@import '../../assets/style/elements/cveTableStacked.scss';

.cve-light-gray-bg {
  background-color: #FFF;
  border-radius: $cve-border-radius;
  border: $white-ter solid 1px;
}

.columns {
  margin-top: 0rem !important;
}

.columns:not(:last-child) {
    margin-bottom: 0.5rem !important;
}

.cve-row {
  border: $white-ter solid 2px;
  margin-left: unset !important;
  margin-right: unset !important;
}

td {
  width: 33% !important;
}

.cve-light-gray-table-header {
  text-transform: capitalize;
  background-color: $theme-color-base !important;
  border: 1px solid #F0F0F0 !important;
}

.cve-border-light-gray {
  border: 1px solid #F0F0F0;
}
</style>
