<template>
  <div id="cve-secondary-page-main-container" class="container">
    <div class="columns">
      <div class="column is-3">
        <ul class="content">
          <li>
            <a @click="showNewsType('all')" class="is-capitalized" :class="{'is-active': selectedNewsType === 'all'}">
              All Types ({{newsByType.allCount}})
            </a>
          </li>
          <li v-for="newsTypeObj in newsByType.lists" :key="newsTypeObj.newsType">
            <a @click="showNewsType(newsTypeObj.newsType)" class="is-capitalized" :class="{'is-active': selectedNewsType === newsTypeObj.newsType}">
                          <span class="icon-text">
              <span class="icon">
                <font-awesome-icon size="xs" icon="podcast"  v-if="newsTypeObj.newsType == 'blog'"/>
                <font-awesome-icon size="xs" icon="blog"  v-if="newsTypeObj.newsType == 'podcast'"/>
                <font-awesome-icon size="xs" :icon="['far', 'newspaper']"  v-if="newsTypeObj.newsType == 'news'"/>
                <font-awesome-icon size="xs" :icon="['fab', 'twitter']"  v-if="newsTypeObj.newsType == 'tweet'"/>
              </span>
              <span>{{newsTypeObj.newsType}} ({{newsTypeObj.items.length}})</span>
            </span>
            </a>
          </li>
        </ul>
      </div>
      <div class="column is-9">
        <main id="cve-tertiary-page-main-content" role="main">
          <h1 class="title">News</h1>
          <div class="content" v-for="newsItem in pagination.currentNewsToDisplay" :key="`${newsItem.id}-${newsItem.newsType}`">
            <article class ="media">
              <div class ="media-content">
                <div class ="content">
                  <h2 class="title mb-2 is-size-4">
                    <router-link :to="`/Media/News/item/${newsItem.newsType}/${newsItem.id}`">{{newsItem.title}}</router-link>
                  </h2>
                  <span class ="level is-mobile has-text-grey-dark">
                    <div class ="level-left">
                      <span class ="level-item tag is-rounded has-text-grey-dark is-capitalized">{{newsItem.newsType}}</span>
                      <span class="icon level-item">
                        <font-awesome-icon size="s" icon="blog"  v-if="newsItem.newsType == 'blog'"/>
                        <font-awesome-icon size="s" icon="podcast"  v-if="newsItem.newsType == 'podcast'"/>
                        <font-awesome-icon size="s" :icon="['far', 'newspaper']"  v-if="newsItem.newsType == 'news'"/>
                        <font-awesome-icon size="s" :icon="['fab', 'twitter']"  v-if="newsItem.newsType == 'tweet'"/>
                      </span>
                      <p class="level-item" v-if="newsItem.newsType == 'blog'">By {{newsItem.author.name}}
                        <span class="pl-1" v-if="newsItem.author.organization.name !== 'CVE'">from</span>
                        <a class="pl-1" :href="newsItem.author.organization.url" v-if="newsItem.author.organization.name !== 'CVE'">
                          {{newsItem.author.organization.name}}
                        </a>
                        <span class="pl-3">|</span>
                      </p>
                      <time class ="level-item" :datetime="newsItem.date">{{formatDate(newsItem.date)}}</time>
                    </div>
                  </span>
                  <p v-if="newsItem.newsType == 'blog' || newsItem.newsType == 'news'">
                    {{newsItem.description[0].content}}
                  </p>
                  <div class="is-flex" style="justify-content: left;" v-else>
                    <figure class="media-left image is3by2">
                      <iframe class="has-ratio" src="https://www.youtube.com/embed/MIoV_X18DvE" frameborder="0" allowfullscreen>
                      </iframe>
                    </figure>
                    <p>{{newsItem.description[0].content}}</p>
                  </div>
                </div>
              </div>
            </article>
          </div>
          <nav class="pagination is-centered" aria-label="pagination">
            <button class="button cve-button cve-button-outline" v-bind:disabled="pagination.currentPage > 1 ? false : true"
              @click=getPreviousPage><font-awesome-icon icon="angle-left" /></button>
            <button class ="pagination-next button cve-button cve-button-outline"
              v-bind:disabled="pagination.currentPage >= pagination.totalPages ? true : false"
              @click=getNextPage><font-awesome-icon icon="angle-right" /></button>
            <ul class ="pagination-list" >
              <li v-for="(pageNumber, index) in pagination.pages" :key="index">
                <a v-bind:class="pageNumber == pagination.currentPage ? 'pagination-link cve-button cve-button-outline is-current' :
                  'pagination-link cve-button cve-button-outline'" @click=updatePagination(pageNumber)
                  v-bind:aria-label="'Goto page ' + pageNumber"
                  v-bind:aria-current="(pageNumber == pagination.currentPage) ? 'page' : false">{{pageNumber}}</a>
              </li>
            </ul>
          </nav>
        </main>
      </div>
    </div>
  </div>
</template>

<script>
import newsData from '../../assets/data/news.json';

export default {
  name: 'News',
  data() {
    return {
      newsByType: {},
      selectedNewsType: 'all',
      pagination: {
        totalItems: 0,
        currentPage: 1,
        pageSize: 10,
        totalPages: 0,
        startIndex: 0,
        endIndex: 0,
        maxPages: 10,
        pages: [],
        currentNewsToDisplay: [],
      },
    };
  },
  created() {
    this.paginate('all');
    this.sortByNewsType();
  },
  methods: {
    showNewsType(newsType) {
      this.paginate(newsType);
      this.selectedNewsType = newsType;
    },
    sortByNewsType() {
      const newsByType = { allCount: 0, lists: {} };
      newsData.forEach((newsItem) => {
        if (!Object.prototype.hasOwnProperty.call(newsByType.lists, newsItem.newsType)) {
          newsByType.lists[newsItem.newsType] = { newsType: newsItem.newsType, items: [] };
        }

        newsByType.lists[newsItem.newsType].items.push(newsItem);
      });

      newsByType.allCount = newsData.length;

      this.newsByType = newsByType;
    },
    paginate(newsList) {
      // calculate total pages

      this.pagination.totalItems = newsList === 'all' ? newsData.length : this.newsByType.lists[newsList].items.length;
      const totalPages = Math.ceil(this.pagination.totalItems / this.pagination.pageSize);

      // ensure current page isn't out of range
      if (this.pagination.currentPage < 1) {
        this.pagination.currentPage = 1;
      } else if (this.pagination.currentPage > totalPages) {
        this.pagination.currentPage = totalPages;
      }

      let startPage; let
        endPage;
      if (totalPages <= this.pagination.maxPages) {
        // total pages less than max so show all pages
        startPage = 1;
        endPage = totalPages;
      } else {
        // total pages more than max so calculate start and end pages
        const maxPagesBeforeCurrentPage = Math.floor(this.pagination.maxPages / 2);
        const maxPagesAfterCurrentPage = Math.ceil(this.pagination.maxPages / 2) - 1;
        if (this.pagination.currentPage <= maxPagesBeforeCurrentPage) {
          // current page near the start
          startPage = 1;
          endPage = this.pagination.maxPages;
        } else if (this.pagination.currentPage + maxPagesAfterCurrentPage >= totalPages) {
          // current page near the end
          startPage = totalPages - this.pagination.maxPages + 1;
          endPage = totalPages;
        } else {
          // current page somewhere in the middle
          startPage = this.pagination.currentPage - maxPagesBeforeCurrentPage;
          endPage = this.pagination.currentPage + maxPagesAfterCurrentPage;
        }
      }

      // calculate start and end item indexes
      this.pagination.startIndex = (this.pagination.currentPage - 1) * this.pagination.pageSize;
      this.pagination.endIndex = Math.min(this.pagination.startIndex + this.pagination.pageSize - 1, this.pagination.totalItems - 1);

      // create an array of pages to loop through in the pager control
      this.pagination.pages = Array.from(Array((endPage + 1) - startPage).keys()).map((i) => startPage + i);
      this.pagination.totalPages = totalPages;

      this.pagination.currentNewsToDisplay = newsList === 'all' ? newsData.slice(this.pagination.startIndex, this.pagination.endIndex + 1)
        : this.newsByType.lists[newsList].items.slice(this.pagination.startIndex, this.pagination.endIndex + 1);
    },
    updatePagination(pageNumber) {
      this.pagination.currentPage = pageNumber;
      this.paginate(this.selectedNewsType);
    },
    getPreviousPage() {
      this.pagination.currentPage -= 1;
      this.paginate(this.selectedNewsType);
    },
    getNextPage() {
      this.pagination.currentPage += 1;
      this.paginate(this.selectedNewsType);
    },
    formatDate(newsDate) {
      const yyyymmdd = newsDate.split('-');
      const formattedDate = new Date();
      formattedDate.setFullYear(parseInt(yyyymmdd[0], 10));
      formattedDate.setMonth(parseInt(yyyymmdd[1] - 1, 10));
      formattedDate.setDate(parseInt(yyyymmdd[2], 10));
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      return formattedDate.toLocaleDateString(undefined, options);
    },
  },
};
</script>

<!-- Add "scoped" attribute to limit CSS to this component only -->
<style scoped lang="scss">
@import '../../assets/style/globals.scss';

.is-active {
  color: $black;
}
</style>
